# OT Learning Web Site â€“ Full Source Code

Below is a minimal yet extendâ€‘able Flaskâ€‘based web service that meets your first requirement: **â€œå­¦è¡“ PDF â†’ æ§‹é€ åŒ–ãƒãƒ¼ãƒˆå¤‰æ›ãƒ„ãƒ¼ãƒ«â€**.  
Copy the entire snippet into a fresh folder, keep the treeâ€‘structure, run `pip install -r requirements.txt`, then launch with `python app.py`.  
Tailwindâ€¯CSS gives it a clean look; all extra future services can be added as additional blue â€œcardâ€ sections in `index.html`.

---

```text
ğŸ“‚ ot_learning_site/
â”‚  app.py
â”‚  requirements.txt
â”‚
â”œâ”€ services/
â”‚   â”œâ”€ __init__.py
â”‚   â”œâ”€ pdf_to_markdown.py
â”‚   â”œâ”€ summarize.py
â”‚   â”œâ”€ keywords.py
â”‚   â””â”€ ocr_figures.py
â”‚
â”œâ”€ templates/
â”‚   â”œâ”€ base.html
â”‚   â”œâ”€ index.html
â”‚   â””â”€ result.html
â”‚
â””â”€ static/
    â”œâ”€ css/style.css
    â””â”€ js/main.js
```
```

---

### requirements.txt
```text
Flask==3.0.2
PyMuPDF==1.24.0
pdf2image==1.17.0
pytesseract==0.3.10
Pillow==10.3.0
transformers==4.42.0
sentencepiece==0.2.0
torch==2.2.2
nltk==3.8.1
```

---

### app.py
```python
from flask import Flask, render_template, request, send_file, redirect, url_for, flash
from werkzeug.utils import secure_filename
from pathlib import Path
import uuid, shutil, os, io, datetime
from services.pdf_to_markdown import convert_pdf

UPLOAD_DIR = Path("uploads")
OUTPUT_DIR = Path("outputs")
UPLOAD_DIR.mkdir(exist_ok=True)
OUTPUT_DIR.mkdir(exist_ok=True)

ALLOWED_EXT = {".pdf"}

app = Flask(__name__)
app.config["SECRET_KEY"] = "change-me"  # needed for flash messages


def allowed(filename: str) -> bool:
    return Path(filename).suffix.lower() in ALLOWED_EXT


@app.route("/")
def index():
    return render_template("index.html")


@app.route("/upload", methods=["POST"])
def upload():
    if "pdf" not in request.files:
        flash("ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚", "warning")
        return redirect(url_for("index"))

    f = request.files["pdf"]
    if f.filename == "":
        flash("PDFã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚", "danger")
        return redirect(url_for("index"))

    if not allowed(f.filename):
        flash("PDF å½¢å¼ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚", "danger")
        return redirect(url_for("index"))

    file_id = uuid.uuid4().hex
    tmp_pdf = UPLOAD_DIR / f"{file_id}.pdf"
    f.save(tmp_pdf)

    md_text, figures = convert_pdf(tmp_pdf)

    md_path = OUTPUT_DIR / f"{file_id}.md"
    md_path.write_text(md_text, encoding="utf-8")

    # clean uploaded pdf (optional)
    try:
        tmp_pdf.unlink()
    except Exception:
        pass

    return render_template("result.html", markdown=md_text, download=url_for("download_md", file_id=file_id))


@app.route("/download/<file_id>")
def download_md(file_id):
    md_path = OUTPUT_DIR / f"{file_id}.md"
    if md_path.exists():
        return send_file(md_path, as_attachment=True)
    flash("ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚", "danger")
    return redirect(url_for("index"))


if __name__ == "__main__":
    app.run(debug=True, port=5000)
```

---

### services/__init__.py
```python
# makes the folder a package. You can expose helper funcs here if desired.
```

---

### services/pdf_to_markdown.py
```python
"""Highâ€‘level orchestration for PDF â†’ Markdown."""
from pathlib import Path
import tempfile, shutil
import fitz  # PyMuPDF
from .summarize import summarize_text
from .keywords import extract_keywords
from .ocr_figures import extract_figure_captions


def _is_heading(block: fitz.TextBlock, threshold: int = 15) -> bool:
    """Rough heuristic: fontâ€‘size larger than threshold â†’ heading"""
    font_sizes = [span[1] for span in block.spans]
    return max(font_sizes, default=0) >= threshold


def convert_pdf(pdf_path: Path) -> tuple[str, list[str]]:
    doc = fitz.open(pdf_path)
    sections = []
    current = {"title": "", "content": ""}

    for page in doc:
        blocks = page.get_text("dict")["blocks"]
        for b in blocks:
            if b["type"] != 0:
                continue  # ignore images here â€“ OCR later
            block = fitz.TextBlock(b)
            text = block.plaintext.strip()
            if not text:
                continue
            if _is_heading(block):
                # new section
                if current["title"] or current["content"]:
                    sections.append(current)
                current = {"title": text, "content": ""}
            else:
                current["content"] += " " + text
    # append last
    if current["title"] or current["content"]:
        sections.append(current)

    # build markdown
    md_lines = []
    full_text = ""
    for sec in sections:
        md_lines.append(f"## {sec['title']}")
        md_lines.append("\n")
        md_lines.append(sec["content"].strip())
        md_lines.append("\n\n")
        full_text += " " + sec["content"].strip()

    # summary & keywords for entire paper
    summary = summarize_text(full_text)
    md_lines.insert(0, "# è«–æ–‡è¦ç´„\n" + summary + "\n\n")
    key_words = extract_keywords(full_text)
    md_lines.insert(2, "**ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:** " + ", ".join(key_words) + "\n\n")

    # OCR important figures (first 5 images >50â€¯kB)
    captions = extract_figure_captions(pdf_path)
    if captions:
        md_lines.append("---\n## é‡è¦å›³è¡¨ OCR ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³\n")
        for cap in captions:
            md_lines.append(f"- {cap}")

    return "\n".join(md_lines), captions
```

---

### services/summarize.py
```python
from transformers import pipeline
import nltk
nltk.download("punkt", quiet=True)

_summer = pipeline("summarization", model="facebook/bart-large-cnn", device_map="auto")


def summarize_text(text: str, max_words: int = 150) -> str:
    """Return a concise Japanese summary."""
    if len(text.split()) < 50:
        return text
    # pipeline handles tokenization limits internally
    summary = _summer(text[:4000])[0]["summary_text"]
    return summary
```

---

### services/keywords.py
```python
import nltk, math, re
from collections import Counter
nltk.download("stopwords", quiet=True)
STOP = set(nltk.corpus.stopwords.words("english")) | set("ã® ã“ã¨ ãªã© ãŸã‚ ãã‚Œ ã“ã‚Œ ãã® ã¨ã ã¾ãŸ ã«ã‚ˆã‚Š ã•ã‚‰ã«".split())


def extract_keywords(text: str, n: int = 8):
    words = re.findall(r"[\wä¸€-é¾¥]{2,}", text.lower())
    cnt = Counter(w for w in words if w not in STOP)
    total = sum(cnt.values())
    scores = {w: c / total * math.log(total / (1 + c)) for w, c in cnt.items()}
    return [w for w, _ in sorted(scores.items(), key=lambda kv: kv[1], reverse=True)[:n]]
```

---

### services/ocr_figures.py
```python
from pathlib import Path
import fitz, tempfile
from PIL import Image
import pytesseract


def extract_figure_captions(pdf_path: Path, max_images: int = 5):
    doc = fitz.open(pdf_path)
    captions = []
    for page in doc:
        images = page.get_images(full=True)
        for img_index, img in enumerate(images):
            xref = img[0]
            base_image = doc.extract_image(xref)
            if base_image["size"] < 50_000:  # skip tiny images
                continue
            with tempfile.NamedTemporaryFile(suffix=".png", delete=True) as tmp:
                tmp.write(base_image["image"])
                tmp.flush()
                cap = pytesseract.image_to_string(Image.open(tmp.name), lang="eng+jpn")
                cap = cap.strip()
                if cap:
                    captions.append(cap)
                if len(captions) >= max_images:
                    return captions
    return captions
```

---

### templates/base.html
```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>OT Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"/>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">
    <header class="bg-gradient-to-r from-indigo-600 to-sky-500 text-white p-6 shadow-lg">
        <h1 class="text-3xl font-bold tracking-wide">OT Learning Hub</h1>
        <p class="text-sm mt-1 opacity-80">ä½œæ¥­ç™‚æ³•å£«ã®ãŸã‚ã®ãƒªã‚µãƒ¼ãƒ &amp; ãƒãƒ¼ãƒˆä½œæˆãƒãƒ¼ã‚¿ãƒ«</p>
    </header>
    <main class="flex-grow container mx-auto px-4 py-8">
        {% block content %}{% endblock %}
    </main>
    <footer class="bg-slate-800 text-slate-200 text-xs py-4 text-center">
        &copy; {{ now.year }} OT Learning Hub â€” Powered by Flask
    </footer>
</body>
</html>
```

---

### templates/index.html
```html
{% extends 'base.html' %}
{% block content %}
<section class="max-w-3xl mx-auto bg-white/90 backdrop-blur rounded-2xl shadow-xl p-8">
    <h2 class="text-2xl font-semibold mb-4">å­¦è¡“ PDF â†’ æ§‹é€ åŒ–ãƒãƒ¼ãƒˆå¤‰æ›ãƒ„ãƒ¼ãƒ«</h2>
    <form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data" class="space-y-4">
        <input id="pdf" name="pdf" type="file" accept="application/pdf" required class="block w-full text-sm text-slate-700"/>
        <button type="submit" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦å¤‰æ›</button>
    </form>
</section>

<!-- Future service cards -->
<section class="mt-10 grid md:grid-cols-2 gap-6">
    <div class="bg-white p-6 rounded-xl shadow-md">
        <h3 class="font-bold mb-2">ã‚µãƒ¼ãƒ“ã‚¹ #2ï¼ˆé–‹ç™ºäºˆå®šï¼‰</h3>
        <p class="text-sm text-slate-600">ã“ã“ã«è¿½åŠ äºˆå®šã®ãƒ„ãƒ¼ãƒ«ç´¹ä»‹ãƒ†ã‚­ã‚¹ãƒˆã€‚</p>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-md">
        <h3 class="font-bold mb-2">ã‚µãƒ¼ãƒ“ã‚¹ #3ï¼ˆé–‹ç™ºäºˆå®šï¼‰</h3>
        <p class="text-sm text-slate-600">ã“ã“ã«è¿½åŠ äºˆå®šã®ãƒ„ãƒ¼ãƒ«ç´¹ä»‹ãƒ†ã‚­ã‚¹ãƒˆã€‚</p>
    </div>
</section>
{% endblock %}
```

---

### templates/result.html
```html
{% extends 'base.html' %}
{% block content %}
<article class="prose prose-slate max-w-none">
    <h2>å¤‰æ›çµæœ</h2>
    <p class="mb-4">
        <a href="{{ download }}" class="text-indigo-600 hover:underline">Markdown ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (.md)</a>
    </p>
    <pre class="whitespace-pre-wrap bg-slate-100 p-4 rounded-lg overflow-x-auto">{{ markdown }}</pre>
</article>
{% endblock %}
```

---

### static/css/style.css
```css
/* è¿½åŠ ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ã€‚Tailwind ã§è¶³ã‚Šãªã„ç´°ã‹ãªèª¿æ•´ã«åˆ©ç”¨ */
body {
    font-family: "Inter", "Noto Sans JP", sans-serif;
}
```

---

### static/js/main.js
```js
// ä»Šå¾Œã® JavaScript æ‹¡å¼µç”¨ã€‚ç¾åœ¨ã¯æœªä½¿ç”¨ã€‚
```

---

> **ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œæ‰‹é †**  
> 1. Windows ã§ Tesseractâ€‘OCR ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€ç’°å¢ƒå¤‰æ•° Path ã« `tesseract.exe` ã®å ´æ‰€ã‚’è¿½åŠ ã€‚  
> 2. `python -m venv venv && venv\Scripts\activate` ã§ä»®æƒ³ç’°å¢ƒã‚’ä½œæˆã€‚  
> 3. `pip install -r requirements.txt` ã§ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å°å…¥ã€‚  
> 4. `python app.py` ã‚’å®Ÿè¡Œã—ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ <http://127.0.0.1:5000> ã‚’é–‹ãã€‚  
> 5. PDF ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦å¤‰æ›çµæœã‚’ç¢ºèªã€‚  
> 6. Tailwind CDN ã®ã¿åˆ©ç”¨ã®ãŸã‚ãƒ“ãƒ«ãƒ‰ä¸è¦ã€‚  
> 7. å°†æ¥ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯ `templates/index.html` ã®ã‚«ãƒ¼ãƒ‰ã‚’ãƒªãƒ³ã‚¯ã«å¤‰æ›´ã—ã€å¯¾å¿œã™ã‚‹ Flask ãƒ«ãƒ¼ãƒˆã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§æ‹¡å¼µå¯èƒ½ã€‚

ã“ã‚Œã§ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆä¸€æ’ƒã§å‹•ãæœ€å°æ§‹æˆãŒå®Œæˆã§ã™ ğŸš€
